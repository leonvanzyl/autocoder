name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Push CI"]
    branches: [main, master]
    types:
      - completed

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.event.workflow_run.head_branch }}
  cancel-in-progress: false

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    env:
      DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH || '/opt/autocoder' }}
      TARGET_BRANCH: ${{ secrets.VPS_BRANCH || 'main' }}
      VPS_PORT: ${{ secrets.VPS_PORT || '22' }}
      IMAGE_LATEST: ghcr.io/${{ github.repository }}:latest
      IMAGE_SHA: ghcr.io/${{ github.repository }}:${{ github.event.workflow_run.head_sha }}
    steps:
      - name: Deploy over SSH with Docker Compose
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ env.VPS_PORT }}
          envs: DEPLOY_PATH,TARGET_BRANCH,IMAGE_LATEST,IMAGE_SHA
          script: |
            set -euo pipefail

            if [ -z "${DEPLOY_PATH:-}" ]; then
              echo "VPS_DEPLOY_PATH secret is required"; exit 1;
            fi

            if [ ! -d "$DEPLOY_PATH/.git" ]; then
              echo "ERROR: $DEPLOY_PATH is missing a git repo. Clone the repository there and keep your .env file."; exit 1;
            fi

            cd "$DEPLOY_PATH"

            if [ ! -f .env ]; then
              echo "WARNING: .env not found in $DEPLOY_PATH. Deployment will continue without it.";
            fi

            git fetch --all
            if ! git show-ref --verify --quiet "refs/heads/$TARGET_BRANCH"; then
              git fetch origin "$TARGET_BRANCH" || true
            fi

            if git show-ref --verify --quiet "refs/heads/$TARGET_BRANCH"; then
              git checkout "$TARGET_BRANCH"
              git pull --ff-only origin "$TARGET_BRANCH"
            else
              echo "Branch $TARGET_BRANCH not found, trying main or master"
              git checkout main 2>/dev/null || git checkout master
              git pull --ff-only origin main 2>/dev/null || git pull --ff-only origin master
            fi

            if command -v docker &>/dev/null && docker compose version &>/dev/null; then
              DOCKER_CMD="docker compose"
            elif command -v docker-compose &>/dev/null; then
              DOCKER_CMD="docker-compose"
            else
              echo "Docker Compose is not installed on the VPS."; exit 1;
            fi

            export IMAGE="${IMAGE_SHA:-$IMAGE_LATEST}"

            $DOCKER_CMD down --remove-orphans || true
            docker image prune -af || true
            docker builder prune -af || true

            echo "Pulling image ${IMAGE} ..."
            if ! $DOCKER_CMD pull; then
              echo "SHA tag pull failed, falling back to latest..."
              export IMAGE="$IMAGE_LATEST"
              $DOCKER_CMD pull || { echo "Image pull failed"; exit 1; }
            fi

            $DOCKER_CMD up -d --remove-orphans

            echo "Running smoke test on http://127.0.0.1:8888/health and /readiness ..."
            retries=12
            until curl -fsS --max-time 5 http://127.0.0.1:8888/health >/dev/null; do
              retries=$((retries - 1))
              if [ "$retries" -le 0 ]; then
                echo "Health check failed after retries."
                exit 1
              fi
              echo "Waiting for health... ($retries retries left)"
              sleep 5
            done

            retries=12
            until curl -fsS --max-time 5 http://127.0.0.1:8888/readiness >/dev/null; do
              retries=$((retries - 1))
              if [ "$retries" -le 0 ]; then
                echo "Readiness check failed after retries."
                exit 1
              fi
              echo "Waiting for readiness... ($retries retries left)"
              sleep 5
            done

            echo "Service responded successfully to health and readiness."
